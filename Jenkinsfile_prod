pipeline {
    agent {
        label 'Dev_Ops_2'
    }

    environment {
        JIRA_SITE = 'CME JIRA'
        JIRA_BASE_URL = 'http://10.88.96.79:8080'
        JIRA_CREDENTIALS = 'cme-jira-credentials'
        JIRA_PROJECT_KEY = 'CME'
        JIRA_ISSUE_TYPE_BUILD = 10011
        JIRA_TRANSITION_START = 11
        JIRA_TRANSITION_FINISH = 21
    }

    options {
        skipDefaultCheckout()
        timeout(time: 1, unit: 'HOURS')
        timestamps()
        ansiColor('xterm')
    }

    stages {
        stage('Pre-Build') {
            steps {
                script {
                    // Create new JIRA build issue
                    issue = [
                        fields: [
                            project: [key: "${JIRA_PROJECT_KEY}"],
                            summary: "[JenkinsCI][PRODUCTION] Build #${env.BUILD_NUMBER}",
                            labels: [
                                "PRODUCTION",
                            ],
                            // assignee: [name: "JenkinsCI"],
                            issuetype: [id: "${JIRA_ISSUE_TYPE_BUILD}"]
                        ]
                    ]
                    response = jiraNewIssue issue: issue
                    env.BUILD_TICKET_ID = response.data.id

                    // Start the JIRA build issue
                    jiraTransitionIssue idOrKey: env.BUILD_TICKET_ID, input: [
                        transition: [
                            id: "${JIRA_TRANSITION_START}",
                        ]
                    ]
                }
            }
        }

        stage('Rerouting Load Balancer') {
            sleep 60
        }

        stage('AWS Deploy Production') {
            steps {
                sh 'chmod +x deploy-aws.sh'
                sh './deploy-aws.sh'
            }
        }
    }

    post {
        always {
            // Mark Build as Done
            jiraTransitionIssue idOrKey: env.BUILD_TICKET_ID, input: [
                transition: [
                    id: "${JIRA_TRANSITION_FINISH}",
                ]
            ]
        }

        success {
            jiraEditIssue idOrKey: env.BUILD_TICKET_ID, issue: [
                fields: [
                    project: [key: "${JIRA_PROJECT_KEY}"],
                    customfield_10036: [value: 'SUCCESS'],
                    issuetype: [id: "${JIRA_ISSUE_TYPE_BUILD}"]
                ]
            ]

            emailext body: """
            <p>Build URL: ${env.BUILD_URL}</p>

            <p>Status: SUCCESS</p>

            <p>Please find attached the Log and Test Reports for this build.</p>
            
            <p>To promote this build to Production please visit: http://10.88.96.73:8081/jenkins/job/CME_DevOps_Demo_Production/</p>
            """, mimeType: 'text/html', subject: "[Jenkins][${env.JOB_NAME}] Build #${env.BUILD_NUMBER}", to: "hunglk1@fsoft.com.vn", attachLog: true, attachmentsPattern: "reports/*"
        }

        failure {
            jiraEditIssue idOrKey: env.BUILD_TICKET_ID, issue: [
                fields: [
                    project: [key: "${JIRA_PROJECT_KEY}"],
                    customfield_10036: [value: 'FAILURE'],
                    issuetype: [id: "${JIRA_ISSUE_TYPE_BUILD}"]
                ]
            ]

            emailext body: """
            <p>Build URL: ${env.BUILD_URL}</p>

            <p>Status: FAILURE</p>

            Please find attached the Log and Test Reports for this build.

            """, mimeType: 'text/html', subject: "[Jenkins][${env.JOB_NAME}] Build #${env.BUILD_NUMBER}", to: "hunglk1@fsoft.com.vn", attachLog: true, attachmentsPattern: "reports/*"
        }
    }
}